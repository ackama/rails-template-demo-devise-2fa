<h2>Log in</h2>

<div data-controller="two-factor-aware-sign-in" >
  <%= form_with(url: user_check_2fa_requirement_path, data: { "two-factor-aware-sign-in-target": "firstFactorForm" }) do |f| %>
    <div class="mb-3">
      <%= f.label :email, "Email", class: "form-label" %>
      <%= f.email_field :email, autofocus: true, autocomplete: "email", class: "form-control" %>
    </div>

    <div class="mb-3">
      <%= f.label :password, "Password", class: "form-label" %>
      <%= f.password_field :password, autocomplete: "current-password", class: "form-control" %>
    </div>

    <% if devise_mapping.rememberable? %>
      <div class="mb-3 form-check">
        <%= f.check_box :remember_me, class: "form-check-input" %>
        <%= f.label :remember_me, "Remember me", class: "form-check-label" %>
      </div>
    <% end %>

    <%= f.button "Log in", type: "button", class: "btn btn-primary", data: { action: "click->two-factor-aware-sign-in#submitFirstFactor" } %>
  <% end %>

  <%=
    form_for(resource,
      as: resource_name,
      url: session_path(resource_name),
      html: { class: "d-none" },
      data: { "two-factor-aware-sign-in-target": "secondFactorForm" }
    ) do |f| %>
      <%= f.hidden_field :email, data: { "two-factor-aware-sign-in-target": "secondFactorFormEmail" } %>
      <%= f.hidden_field :password, data: { "two-factor-aware-sign-in-target": "secondFactorFormPassword" } %>
      <%= f.hidden_field :remember_me, data: { "two-factor-aware-sign-in-target": "secondFactorFormRememberMe" } %>

    <div class="mb-3">
      <%= f.label :otp_attempt, "2FA (Two Factor Auth) code", class: "form-label" %>
      <%
      # Input must be wide enough to show a backup code as well as the usual 6 digit code.
      # For security it shouldn't be exactly the same width as the backup code
      # because attackers could use it as a (fairly weak) signal to determin how
      # long the backup codes are which helps in brute forcing
      %>
      <%= f.text_field :otp_attempt, class: "form-control" %>
    </div>

    <%= f.submit "Log in", class: "btn btn-primary", data: { turbo: false } %>
  <% end %>
</div>

<%= render "users/shared/links" %>
